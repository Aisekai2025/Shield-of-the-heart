<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥­å‹™ç”¨ãƒ¡ãƒ¢å¸³</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* === å…±é€šã‚¹ã‚¿ã‚¤ãƒ« === */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f5f7; color: #333; }
        .hidden { display: none !important; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        button { cursor: pointer; padding: 8px 16px; border: none; border-radius: 4px; background-color: #0056b3; color: white; font-size: 14px; }
        button:hover { background-color: #004494; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        input, textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* === ã‚«ãƒ¢ãƒ•ãƒ©ãƒ¼ã‚¸ãƒ¥ãƒ¢ãƒ¼ãƒ‰ === */
        #camouflage-mode { background-color: #fff; height: 100vh; padding: 20px; box-sizing: border-box; }
        #trigger-title { font-size: 20px; font-weight: normal; color: #555; user-select: none; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #camo-textarea { width: 100%; height: calc(100vh - 80px); border: none; outline: none; resize: none; font-size: 14px; }

        /* === è¨¼æ‹ åé›†ãƒ¢ãƒ¼ãƒ‰ === */
        #shield-mode { background-color: #f4f5f7; min-height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; overflow-x: auto; }
        .tab-btn { background-color: #e0e0e0; color: #333; }
        .tab-btn.active { background-color: #333; color: #fff; }
        .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .record-item, .diary-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; color: white; }
        .badge-structure { background-color: #fd7e14; }
        .badge-personal { background-color: #6c757d; }
        .badge-harassment { background-color: #dc3545; }
    </style>
</head>
<body>

    <div id="camouflage-mode">
        <h1 id="trigger-title">æ¥­å‹™ãƒ¡ãƒ¢</h1>
        <textarea id="camo-textarea" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
    </div>

    <div id="shield-mode" class="container hidden">
        <div class="header">
            <h2>ğŸ›¡ï¸ å¿ƒã®ç›¾ (Local Edition)</h2>
            <button onclick="toggleMode()">ğŸ“ ã‚«ãƒ¢ãƒ•ãƒ©ãƒ¼ã‚¸ãƒ¥ã«æˆ»ã‚‹</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('record')">ğŸ™ï¸ ã‚¹ãƒ†ãƒ«ã‚¹éŒ²éŸ³</button>
            <button class="tab-btn" onclick="switchTab('diary')">ğŸ““ è¨¼æ‹ æ—¥è¨˜</button>
            <button class="tab-btn" onclick="switchTab('template')">ğŸ“„ åˆ‡ã‚Šè¿”ã—ãƒ†ãƒ³ãƒ—ãƒ¬</button>
            <button class="tab-btn" onclick="switchTab('export')">ğŸ“¦ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        </div>

        <div id="tab-record" class="tab-content">
            <div class="card">
                <h3>éŒ²éŸ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
                <p>â€»ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™ã€‚éŒ²éŸ³ä¸­ã¯ã‚¿ãƒ–ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚</p>
                <button id="btn-start-record" class="danger" onclick="startRecording()">ğŸ”´ éŒ²éŸ³é–‹å§‹</button>
                <button id="btn-stop-record" class="hidden" onclick="stopRecording()">â¹ï¸ éŒ²éŸ³åœæ­¢</button>
                <span id="recording-status" style="margin-left: 10px; color: red; font-weight: bold;" class="hidden">éŒ²éŸ³ä¸­...</span>
            </div>
            <div class="card">
                <h3>ä¿å­˜ã•ã‚ŒãŸéŒ²éŸ³</h3>
                <div id="record-list"></div>
            </div>
        </div>

        <div id="tab-diary" class="tab-content hidden">
            <div class="card">
                <h3>æ–°è¦è¨˜éŒ²</h3>
                <label>ç™ºç”Ÿæ—¥æ™‚:</label>
                <input type="datetime-local" id="diary-date">
                
                <label>åŠ å®³è€…ã®ç™ºè¨€ãƒ»è¡Œå‹•:</label>
                <textarea id="diary-content" rows="3" placeholder="ã€ŒãŠå‰ãŒä½¿ãˆãªã„ã‹ã‚‰ä»•äº‹ãŒå›ã‚‰ãªã„ã‚“ã ã€ç­‰"></textarea>
                
                <label>è‡ªå·±åˆ†æï¼ˆè«–ç†ã™ã‚Šæ›¿ãˆé˜²æ­¢ï¼‰:</label>
                <select id="diary-analysis">
                    <option value="structure">æ§‹é€ çš„å•é¡Œï¼ˆäººå“¡ãƒ»äºˆç®—ä¸è¶³ã€æ¥­å‹™ãƒ•ãƒ­ãƒ¼ã®æ¬ é™¥ï¼‰</option>
                    <option value="harassment">ç´”ç²‹ãªãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆï¼ˆäººæ ¼å¦å®šã€æš´è¨€ï¼‰</option>
                    <option value="personal">å€‹äººã®å•é¡Œï¼ˆç´”ç²‹ãªè‡ªåˆ†ã®ãƒŸã‚¹ â€»éåº¦ã«è²¬ã‚ãªã„ã“ã¨ï¼‰</option>
                </select>

                <label>å®¢è¦³çš„ãªäº‹å®Ÿãƒ»åè¨¼ãƒ¡ãƒ¢:</label>
                <textarea id="diary-fact" rows="3" placeholder="äººå“¡ãŒå‰å¹´æ¯”ãƒã‚¤ãƒŠã‚¹1åã€‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚‚æœªæ•´å‚™ã®ã¾ã¾æ¥­å‹™ã‚’æŒ¯ã‚‰ã‚ŒãŸã€‚ç­‰"></textarea>
                
                <button onclick="saveDiary()">ğŸ’¾ ä¿å­˜</button>
            </div>
            <div class="card">
                <h3>æ—¥è¨˜ä¸€è¦§</h3>
                <div id="diary-list"></div>
            </div>
        </div>

        <div id="tab-template" class="tab-content hidden">
            <div class="card">
                <h3>æ³•çš„ãªã€Œåˆ‡ã‚Šè¿”ã—ã€ã‚«ãƒ³ãƒ‹ãƒ³ã‚°ãƒšãƒ¼ãƒ‘ãƒ¼</h3>
                <p>äººäº‹é™¢æŒ‡é‡ï¼ˆãƒ‘ãƒ¯ãƒ¼ãƒ»ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆã®é˜²æ­¢ç­‰ï¼‰ã«åŸºã¥ãã€è§’ã‚’ç«‹ã¦ãšã«èº«ã‚’å®ˆã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºé›†ã§ã™ã€‚</p>
                <ul>
                    <li><strong>ç†ä¸å°½ãªå±è²¬ã«å¯¾ã—ã¦ï¼š</strong><br>ã€Œã”æŒ‡å°ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»Šå¾Œã®æ”¹å–„ã®ãŸã‚ã€ä»Šã®å…·ä½“çš„ãªã”æŒ‡æ‘˜å†…å®¹ã‚’ãƒ¡ãƒ¼ãƒ«ã§ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚ã€</li>
                    <li><strong>äººæ ¼ã‚’å¦å®šã™ã‚‹æš´è¨€ã«å¯¾ã—ã¦ï¼š</strong><br>ã€Œç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ä»Šã®ç™ºè¨€ã¯äººäº‹é™¢è¦å‰‡10-16ã«æŠµè§¦ã™ã‚‹æã‚ŒãŒã‚ã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚è‡ªåˆ†ã®èº«ã‚’å®ˆã‚‹ãŸã‚ã€ãƒ¡ãƒ¢ã‚’å–ã‚‰ã›ã¦ã„ãŸã ã„ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ã€‚ã€</li>
                    <li><strong>å€‹äººã®ã‚­ãƒ£ãƒ‘ã‚’è¶…ãˆã‚‹æ¥­å‹™ã®æŠ¼ã—ä»˜ã‘ï¼š</strong><br>ã€Œç¾åœ¨ã®æ¥­å‹™é‡ï¼ˆâ—¯â—¯ã¨â–³â–³ï¼‰ã‚’æŠ±ãˆã¦ãŠã‚Šã€ã“ã‚Œä»¥ä¸Šã¯ãŠå¼•ãå—ã‘ã™ã‚‹ã¨çµ„ç¹”ã«ã”è¿·æƒ‘ã‚’ã‹ã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å„ªå…ˆé †ä½ã«ã¤ã„ã¦ä¸Šé•·ã‚’äº¤ãˆã¦ã”ç›¸è«‡ã•ã›ã¦ãã ã•ã„ã€‚ã€</li>
                    <li><strong>ã€ŒãŠå‰ãŒç„¡èƒ½ã ã‹ã‚‰ã€ç­‰ã€æ§‹é€ çš„å•é¡Œã‚’å€‹äººã«è»¢å«ã•ã‚ŒãŸæ™‚ï¼ˆå¿ƒã®ä¸­ã§å”±ãˆã‚‹ç”¨ï¼‰ï¼š</strong><br>ã€Œã“ã‚Œã¯ç§ã®èƒ½åŠ›ä¸è¶³ã§ã¯ãªãã€çµ„ç¹”ã®äººå“¡é…ç½®ã¨ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã®æ¬ é™¥ã§ã‚ã‚‹ã€‚ï¼ˆåŸå› ã®åˆ†é›¢ï¼‰ã€</li>
                </ul>
            </div>
        </div>

        <div id="tab-export" class="tab-content hidden">
            <div class="card">
                <h3>è¨¼æ‹ ã®ä¸€æ‹¬æŠ½å‡º</h3>
                <p>ä¿å­˜ã•ã‚ŒãŸã™ã¹ã¦ã®æ—¥è¨˜ã¨éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€ã¤ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
                <p><strong>â€»å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€ä¿¡ã¯ä¸€åˆ‡è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚ã™ã¹ã¦ã“ã®ç«¯æœ«å†…ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚</strong></p>
                <button onclick="exportData()">ğŸ“¦ ã™ã¹ã¦ã®è¨¼æ‹ ã‚’ZIPã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ã‚«ãƒ¢ãƒ•ãƒ©ãƒ¼ã‚¸ãƒ¥UIï¼ˆ3å›ã‚¿ãƒƒãƒ—åˆ¤å®šï¼‰ ---
        let tapCount = 0;
        let tapTimer = null;
        
        document.getElementById('trigger-title').addEventListener('click', () => {
            tapCount++;
            clearTimeout(tapTimer);
            if(tapCount >= 3) {
                toggleMode();
                tapCount = 0;
            } else {
                tapTimer = setTimeout(() => { tapCount = 0; }, 1000); // 1ç§’ä»¥å†…ã«3å›
            }
        });

        function toggleMode() {
            const camo = document.getElementById('camouflage-mode');
            const shield = document.getElementById('shield-mode');
            if (camo.classList.contains('hidden')) {
                camo.classList.remove('hidden');
                shield.classList.add('hidden');
                document.title = "æ¥­å‹™ç”¨ãƒ¡ãƒ¢å¸³";
            } else {
                camo.classList.add('hidden');
                shield.classList.remove('hidden');
                document.title = "ğŸ›¡ï¸ å¿ƒã®ç›¾";
                loadRecords();
                loadDiaries();
            }
        }

        // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // --- 2. ã‚¹ãƒ†ãƒ«ã‚¹éŒ²éŸ³ (MediaRecorder + LocalForage) ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const timestamp = new Date().toISOString();
                    await localforage.setItem(`audio_${timestamp}`, audioBlob);
                    audioChunks = [];
                    loadRecords();
                    alert("éŒ²éŸ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
                };

                mediaRecorder.start();
                isRecording = true;
                document.getElementById('btn-start-record').classList.add('hidden');
                document.getElementById('btn-stop-record').classList.remove('hidden');
                document.getElementById('recording-status').classList.remove('hidden');

                // éŒ²éŸ³é–‹å§‹ã—ãŸã‚‰ã™ãã‚«ãƒ¢ãƒ•ãƒ©ãƒ¼ã‚¸ãƒ¥ã«æˆ»ã‚‹ï¼ˆã‚¹ãƒ†ãƒ«ã‚¹æ€§ï¼‰
                toggleMode();

            } catch (err) {
                alert("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚ŒãŸã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + err);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop()); // ãƒã‚¤ã‚¯è§£æ”¾
                isRecording = false;
                document.getElementById('btn-start-record').classList.remove('hidden');
                document.getElementById('btn-stop-record').classList.add('hidden');
                document.getElementById('recording-status').classList.add('hidden');
            }
        }

        async function loadRecords() {
            const listEl = document.getElementById('record-list');
            listEl.innerHTML = '';
            const keys = await localforage.keys();
            const audioKeys = keys.filter(k => k.startsWith('audio_')).sort().reverse();
            
            if(audioKeys.length === 0) listEl.innerHTML = '<p>éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';

            for (const key of audioKeys) {
                const blob = await localforage.getItem(key);
                const url = URL.createObjectURL(blob);
                const dateStr = new Date(key.replace('audio_', '')).toLocaleString('ja-JP');
                
                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `
                    <strong>${dateStr}</strong><br>
                    <audio controls src="${url}" style="height: 30px; margin-top: 5px;"></audio>
                    <button class="danger" style="padding: 4px 8px; font-size: 12px; float: right;" onclick="deleteItem('${key}')">å‰Šé™¤</button>
                    <div style="clear:both;"></div>
                `;
                listEl.appendChild(div);
            }
        }

        // --- 3. è«–ç†ã™ã‚Šæ›¿ãˆé˜²æ­¢æ—¥è¨˜ ---
        async function saveDiary() {
            const date = document.getElementById('diary-date').value || new Date().toISOString();
            const content = document.getElementById('diary-content').value;
            const analysis = document.getElementById('diary-analysis').value;
            const fact = document.getElementById('diary-fact').value;

            if(!content) return alert("ç™ºè¨€ãƒ»è¡Œå‹•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

            const diaryEntry = { date, content, analysis, fact };
            await localforage.setItem(`diary_${new Date().getTime()}`, diaryEntry);
            
            document.getElementById('diary-content').value = '';
            document.getElementById('diary-fact').value = '';
            loadDiaries();
            alert("æ—¥è¨˜ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        }

        async function loadDiaries() {
            const listEl = document.getElementById('diary-list');
            listEl.innerHTML = '';
            const keys = await localforage.keys();
            const diaryKeys = keys.filter(k => k.startsWith('diary_')).sort().reverse();

            if(diaryKeys.length === 0) listEl.innerHTML = '<p>æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';

            const analysisMap = {
                'structure': { label: 'æ§‹é€ çš„å•é¡Œ', class: 'badge-structure' },
                'harassment': { label: 'ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ', class: 'badge-harassment' },
                'personal': { label: 'å€‹äººã®å•é¡Œ', class: 'badge-personal' }
            };

            for (const key of diaryKeys) {
                const entry = await localforage.getItem(key);
                const dateStr = new Date(entry.date).toLocaleString('ja-JP');
                const badge = analysisMap[entry.analysis];
                
                const div = document.createElement('div');
                div.className = 'diary-item';
                div.innerHTML = `
                    <div><strong>${dateStr}</strong> <span class="badge ${badge.class}">${badge.label}</span></div>
                    <p style="margin: 5px 0;"><strong>ç™ºè¨€ãƒ»è¡Œå‹•:</strong> ${entry.content}</p>
                    <p style="margin: 5px 0; color: #555;"><strong>åè¨¼ãƒ»äº‹å®Ÿ:</strong> ${entry.fact}</p>
                    <button class="danger" style="padding: 2px 6px; font-size: 12px;" onclick="deleteItem('${key}')">å‰Šé™¤</button>
                `;
                listEl.appendChild(div);
            }
        }

        async function deleteItem(key) {
            if(confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                await localforage.removeItem(key);
                loadRecords();
                loadDiaries();
            }
        }

        // --- 4. è¨¼æ‹ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSZip) ---
        async function exportData() {
            const zip = new JSZip();
            const keys = await localforage.keys();
            
            // æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿ã®é›†ç´„
            const diaryKeys = keys.filter(k => k.startsWith('diary_')).sort();
            let diaryText = "=== è¨¼æ‹ æ—¥è¨˜ ===\n\n";
            for (const key of diaryKeys) {
                const entry = await localforage.getItem(key);
                diaryText += `æ—¥æ™‚: ${new Date(entry.date).toLocaleString('ja-JP')}\n`;
                diaryText += `åˆ†æ: ${entry.analysis}\n`;
                diaryText += `ç™ºè¨€: ${entry.content}\n`;
                diaryText += `åè¨¼: ${entry.fact}\n`;
                diaryText += `------------------------\n`;
            }
            zip.file("evidence_diary.txt", diaryText);

            // éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
            const audioKeys = keys.filter(k => k.startsWith('audio_'));
            for (const key of audioKeys) {
                const blob = await localforage.getItem(key);
                const dateStr = key.replace('audio_', '').replace(/[:.]/g, '-');
                zip.file(`audio_${dateStr}.webm`, blob);
            }

            // ZIPç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            zip.generateAsync({type:"blob"}).then(function(content) {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = `kokoro_no_tate_evidence_${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }

        // åˆæœŸåŒ–ï¼šæ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç¾åœ¨æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('diary-date').value = now.toISOString().slice(0,16);

    </script>
</body>
</html>
